// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  email         String    @unique
  password      String
  name          String
  role          String    @default("employee") // employee, lider, admin, super_admin
  avatar        String?
  xp            Int       @default(0)
  level         Int       @default(1)
  streak        Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastActiveAt  DateTime  @default(now())

  // Relations
  coursesCreated Course[]  @relation("InstructorCourses")
  enrollments    Enrollment[]
  progress       LessonProgress[]
  achievements   Achievement[]
  taskAssignments TaskAssignment[] @relation("EmployeeTasks")
}

model Course {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  subtitle        String?
  description     String
  slug            String    @unique
  category        String
  level           String    // beginner, intermediate, advanced
  thumbnail       String?
  price           Float     @default(0)
  isFree          Boolean   @default(true)
  status          String    @default("draft") // draft, published, deleted
  publishedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Soft delete - para recuperar cursos eliminados
  isDeleted       Boolean   @default(false)
  deletedAt       DateTime?
  deletedById     String?   @db.ObjectId

  instructorId    String    @db.ObjectId
  instructor      User      @relation("InstructorCourses", fields: [instructorId], references: [id])

  // Relations
  modules         Module[]
  enrollments     Enrollment[]
}

model Module {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  orderIndex  Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  courseId    String    @db.ObjectId
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // Relations
  lessons     Lesson[]
}

model Lesson {
  id                  String    @id @default(auto()) @map("_id") @db.ObjectId
  title               String
  description         String?
  orderIndex          Int
  lessonType          String    // video, article, quiz
  videoUrl            String?
  videoDuration       Int?      // seconds
  articleContent      String?
  isPreview           Boolean   @default(false)
  transcription       String?   // Full transcription/subtitles text
  transcriptSegments  String?   // JSON string of segments with timestamps
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  moduleId            String    @db.ObjectId
  module              Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  // Relations
  progress            LessonProgress[]
}

model Enrollment {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  progressPercent   Float     @default(0)
  completedLessons  Int       @default(0)
  status            String    @default("active") // active, completed
  enrolledAt        DateTime  @default(now())
  completedAt       DateTime?
  lastAccessedAt    DateTime  @default(now())

  userId            String    @db.ObjectId
  user              User      @relation(fields: [userId], references: [id])

  courseId          String    @db.ObjectId
  course            Course    @relation(fields: [courseId], references: [id])

  @@unique([userId, courseId])
}

model LessonProgress {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  isCompleted     Boolean   @default(false)
  watchTime       Int       @default(0) // seconds
  lastPosition    Int       @default(0) // seconds
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  lastAccessedAt  DateTime  @default(now())

  userId          String    @db.ObjectId
  user            User      @relation(fields: [userId], references: [id])

  lessonId        String    @db.ObjectId
  lesson          Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model Achievement {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  type            String    // first_lesson, 7_day_streak, course_completer, etc.
  earnedAt        DateTime  @default(now())

  userId          String    @db.ObjectId
  user            User      @relation(fields: [userId], references: [id])
}

model LessonQuiz {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  lessonId        String    @unique
  questions       String    // JSON array of quiz questions
  generatedAt     DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  attempts        QuizAttempt[]
}

model QuizAttempt {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  lessonQuizId    String    @db.ObjectId
  lessonQuiz      LessonQuiz @relation(fields: [lessonQuizId], references: [id], onDelete: Cascade)
  userId          String
  score           Int       // 0-100
  correctAnswers  Int
  totalQuestions  Int
  answers         String    // JSON of user answers
  completedAt     DateTime  @default(now())
  timeSpent       Int       // seconds
}

// ==================== CHECKLIST MODULE ====================

// Template de tareas que se asignan a empleados
model TaskTemplate {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  description     String?
  frequency       String    // daily, weekly, monthly
  scheduledTime   String?   // HH:MM format for daily tasks with specific time
  scheduledDay    Int?      // 0-6 for weekly (0=Sunday), 1-31 for monthly
  requiresPhoto   Boolean   @default(false)
  category        String?   // cleaning, maintenance, security, etc.
  priority        String    @default("medium") // low, medium, high
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdById     String    @db.ObjectId

  // Relations
  assignments     TaskAssignment[]
}

// Asignación de tareas a empleados específicos
model TaskAssignment {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  taskTemplateId  String    @db.ObjectId
  taskTemplate    TaskTemplate @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)
  employeeId      String    @db.ObjectId
  employee        User      @relation("EmployeeTasks", fields: [employeeId], references: [id])
  assignedAt      DateTime  @default(now())
  isActive        Boolean   @default(true)

  // Relations
  completions     TaskCompletion[]

  @@unique([taskTemplateId, employeeId])
}

// Registro de cumplimiento de tareas
model TaskCompletion {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId    String    @db.ObjectId
  assignment      TaskAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  completedAt     DateTime  @default(now())
  scheduledDate   DateTime  // Fecha para la que estaba programada
  status          String    @default("completed") // completed, pending, missed
  photoUrl        String?   // URL de la foto de evidencia
  photoPublicId   String?   // ID público para eliminar de Cloudinary
  notes           String?   // Notas adicionales del empleado
  completedOnTime Boolean   @default(true)
  verifiedAt      DateTime? // Cuando un admin verificó la tarea
  verifiedById    String?   @db.ObjectId

  @@index([assignmentId, scheduledDate])
}
